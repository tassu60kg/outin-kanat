<!DOCTYPE html>
<html>
  <head>
    <title>temp</title>
    <style>
      table,
      th,
      td {
        border: 1px solid black;
      }
    </style>
  </head>
  <link rel="stylesheet" href="/static/main.css">
  <body>
    <header class="top-bar">
      <div class="top-bar__title">
        <h1>References</h1>
      </div>
      <nav class="top-bar__actions">
        <a class="btn btn--ghost" href="/add_reference">Add reference</a>
        <a class="btn btn--ghost" href="/add_reference_with_doi">Add reference with DOI</a>
        <a class="btn btn--ghost" id="bibtex_link" href="/create_bibtex">Create BibTeX</a>
      </nav>
    </header>
    {% for message in get_flashed_messages() %}
    <p><b>{{ message }}</b></p>
    {% endfor %}
    <br>
    <form method="get" action="/">
      {% if unique_tags %}
      <details>
        <summary>Filter references by tags</summary>
        {% for t in unique_tags %}
          <label>
            <input type="checkbox" name="tags" value="{{ t.tag }}"
                   {% if t.tag in selected_tags %}checked{% endif %}>
            {{ t.tag }}
          </label><br>
        {% endfor %}
        <button type="submit" class="btn btn--small">Show</button>
        <button type="button" onclick="window.location.href='/'" class="btn btn--small">
          Clear filters
        </button>
      </details>
      {% endif %}
    </form>

  </br>

    <table style="width: 100%">
      <tr>
        <th>Type</th>
        <th>Cite key</th>
        <th>Title</th>
        <th>Author</th>
        <th>Year</th>
        <th>Publisher</th>
        <th>Journal</th>
        <th>Booktitle</th>
        <th>Volume</th>
        <th>Pages</th>
        <th>ISBN</th>
        <th>Tags</th>
        <th>Delete</th>
        <th>Update</th>
        <th>Update Tags</th>
      </tr>

      {% for reference in reference %}
      <tr>
        <td>{{ reference[2] }}</td>
        <td>{{ reference[1] }}</td>
        <td>{{ reference[3] }}</td>
        <td>{{ reference[4] }}</td>
        <td>{{ reference[5] }}</td>
        <td>{{ reference[8] }}</td>
        <td>{{ reference[7] }}</td>
        <td>{{ reference[6] }}</td>
        <td>{{ reference[9] }}</td>
        <td>{{ reference[10] }}</td>
        <td>{{ reference[11] }}</td>
        <td>
          {% set ref_tags = [] %} {% for t in tag %} {% if t[0] == reference[0]
          %} {% set _ = ref_tags.append(t[1]) %} {% endif %} {% endfor %} {{
          ref_tags | join(', ') }}
        </td>
        <td><a href="/remove_reference/{{ reference.id }}" class="btn--link">Delete</a></td>
        <td><a href="/update_reference/{{ reference.id }}" class="btn--link">Update</a></td>
        <td>
          <a href="/update_tags/{{ reference.id }}" class="btn--link">Add/Edit tags</a>
        </td>
      </tr>
      {% endfor %}
    </table>
  </body>
<script>
function updateBibtexLink() {
    let checked = [...document.querySelectorAll('input[name="tags"]:checked')]
                 .map(cb => "tags=" + encodeURIComponent(cb.value));

    let url = "/create_bibtex";
    if (checked.length > 0) {
        url += "?" + checked.join("&");
    }

    document.getElementById("bibtex_link").href = url;
}

updateBibtexLink();

document.querySelectorAll('input[name="tags"]').forEach(cb => {
    cb.addEventListener("change", updateBibtexLink);
});
</script>
</html>
